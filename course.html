<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشاهدة الدرس - تعليمي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="container">
                <a href="index.html" class="logo">تعليمي</a>
                <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('show')">☰</button>
                <div class="nav-links" id="navLinks">
                    <span id="userDisplay" style="color:#4361ee;"></span>
                    <a href="index.html">الرئيسية</a>
                    <a href="#" id="logoutBtn" style="display:none;">تسجيل خروج</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="container" style="margin-top:30px;">
        <a href="javascript:history.back()" class="btn-outline btn-sm">← رجوع</a>
        <h1 id="courseTitle" style="margin:20px 0;"></h1>
        <p id="courseDesc" style="color:#475569; margin-bottom:20px;"></p>

        <div class="video-container">
            <div class="video-wrapper">
                <iframe id="player" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div id="interactionOverlay" class="interaction-overlay"></div>
        </div>

        <div style="margin-top:30px;">
            <h2>تفاعلات الدرس</h2>
            <div id="interactionsPanel" class="interactions-list">
                <p>جاري تحميل التفاعلات...</p>
            </div>
        </div>
    </div>

    <div class="modal" id="interactionModal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/youtube.js"></script>
    <script src="js/courses.js"></script>
    <script src="js/interactions.js"></script>
    <script src="js/main.js"></script>
    <script>
        let currentCourse = null;
        let interactions = [];
        let playerInterval = null;

        (async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');
            if (!courseId) {
                showNotification('❌ لم يتم تحديد الدرس', 'error');
                window.location.href = 'index.html';
                return;
            }

            currentCourse = await coursesAPI.getCourseWithInteractions(courseId);
            if (!currentCourse) {
                showNotification('❌ الدورة غير موجودة', 'error');
                window.location.href = 'index.html';
                return;
            }

            interactions = currentCourse.interactions || [];
            document.getElementById('courseTitle').textContent = currentCourse.title;
            document.getElementById('courseDesc').textContent = currentCourse.description;
            document.getElementById('player').src = `https://www.youtube.com/embed/${currentCourse.youtube_video_id}?enablejsapi=1`;

            const panel = document.getElementById('interactionsPanel');
            if (interactions.length === 0) {
                panel.innerHTML = '<p>لا توجد تفاعلات في هذا الدرس.</p>';
            } else {
                panel.innerHTML = interactions.map((inter, index) => {
                    const timeStr = formatTime(inter.time_seconds);
                    let icon = 'fa-question-circle';
                    if (inter.type === 'quiz') icon = 'fa-clipboard-check';
                    else if (inter.type === 'explanation') icon = 'fa-lightbulb';
                    return `
                        <div class="interaction-item" onclick="seekToInteraction(${index})">
                            <div class="interaction-icon"><i class="fas ${icon}"></i></div>
                            <div>
                                <strong>${inter.type === 'question' ? 'سؤال' : inter.type === 'quiz' ? 'اختبار' : 'شرح'}</strong>
                                <p>${inter.title || ''}</p>
                                <small>الوقت: ${timeStr}</small>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            startVideoMonitor();

            const user = await auth.getCurrentUser();
            if (user) {
                document.getElementById('userDisplay').textContent = user.profile?.full_name || user.email;
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    auth.signOut();
                });
            }
        })();

        function startVideoMonitor() {
            let currentTime = 0;
            playerInterval = setInterval(() => {
                currentTime += 1;
                checkInteractions(currentTime);
            }, 1000);
        }

        function checkInteractions(time) {
            document.getElementById('interactionOverlay').innerHTML = '';

            interactions.forEach((inter, index) => {
                if (Math.abs(inter.time_seconds - time) <= 2) {
                    const point = document.createElement('div');
                    point.className = 'interaction-point';
                    point.style.top = '50%';
                    point.style.right = `${(inter.time_seconds / currentCourse.duration) * 100}%`;
                    point.innerHTML = '<i class="fas fa-star"></i>';
                    point.onclick = () => showInteraction(inter);
                    document.getElementById('interactionOverlay').appendChild(point);
                }
            });
        }

        function showInteraction(interaction) {
            const modal = document.getElementById('interactionModal');
            const content = document.getElementById('modalContent');

            if (interaction.type === 'question') {
                const q = interaction.content;
                content.innerHTML = `
                    <h3>${interaction.title || 'سؤال'}</h3>
                    <p>${q.text}</p>
                    ${q.options.map((opt, i) => `
                        <div><input type="radio" name="answer" value="${i}"> ${opt}</div>
                    `).join('')}
                    <button class="btn btn-sm" onclick="submitAnswer(${interaction.id}, ${q.correct})">إرسال</button>
                `;
            } else if (interaction.type === 'quiz') {
                content.innerHTML = `
                    <h3>${interaction.title || 'اختبار'}</h3>
                    <p>اختبار يتكون من ${interaction.question_count || 0} أسئلة (قيد التطوير).</p>
                    <button class="btn btn-sm" onclick="closeModal()">إغلاق</button>
                `;
            } else if (interaction.type === 'explanation') {
                content.innerHTML = `
                    <h3>شرح إضافي</h3>
                    <p>${interaction.content?.text || ''}</p>
                    ${interaction.content?.url ? `<a href="${interaction.content.url}" target="_blank">رابط إضافي</a>` : ''}
                    <button class="btn btn-sm" onclick="closeModal()">إغلاق</button>
                `;
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('interactionModal').classList.remove('active');
        }

        async function submitAnswer(interactionId, correctIndex) {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) {
                showNotification('❌ اختر إجابة أولاً', 'error');
                return;
            }
            const answer = parseInt(selected.value);
            const isCorrect = (answer === correctIndex);

            try {
                await interactionsAPI.saveResponse(interactionId, answer, isCorrect);
                showNotification(isCorrect ? '✅ إجابة صحيحة!' : '❌ إجابة خاطئة', isCorrect ? 'success' : 'error');
                closeModal();
            } catch (error) {
                showNotification('❌ فشل حفظ الإجابة', 'error');
            }
        }

        function seekToInteraction(index) {
            const inter = interactions[index];
            showNotification(`انتقل إلى الوقت ${formatTime(inter.time_seconds)}`, 'info');
        }

        window.addEventListener('beforeunload', () => {
            if (playerInterval) clearInterval(playerInterval);
        });
    </script>
</body>
</html>