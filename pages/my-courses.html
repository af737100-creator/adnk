<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دروسي - تعليمي</title>
    <meta name="description" content="عرض وإدارة جميع الدروس التعليمية التفاعلية">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="../assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="../manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-page">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <h2>تعليمي</h2>
                </div>
                <button class="close-sidebar" id="close-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-user">
                <div class="user-avatar" id="user-avatar">م</div>
                <div class="user-info">
                    <h4 id="user-name">محمد أحمد</h4>
                    <p id="user-email">teacher@example.com</p>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>لوحة التحكم</span>
                        </a>
                    </li>
                    <li>
                        <a href="create-course.html">
                            <i class="fas fa-plus-circle"></i>
                            <span>إنشاء درس جديد</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="my-courses.html">
                            <i class="fas fa-video"></i>
                            <span>دروسي</span>
                            <span class="badge" id="courses-count">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="analytics.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>التقارير</span>
                        </a>
                    </li>
                    <li>
                        <a href="classroom.html">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>الفصول التفاعلية</span>
                        </a>
                    </li>
                    <li>
                        <a href="whiteboard.html">
                            <i class="fas fa-paint-brush"></i>
                            <span>السبورة</span>
                        </a>
                    </li>
                    <li>
                        <a href="students.html">
                            <i class="fas fa-users"></i>
                            <span>الطلاب</span>
                        </a>
                    </li>
                    <li>
                        <a href="settings.html">
                            <i class="fas fa-cog"></i>
                            <span>الإعدادات</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="profile.html" class="profile-link">
                    <i class="fas fa-user"></i>
                    <span>الملف الشخصي</span>
                </a>
                <button onclick="auth.signOut()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل خروج</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>دروسي</h1>
                </div>
                
                <div class="header-right">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-courses" placeholder="ابحث في دروسي...">
                    </div>
                    
                    <button class="btn-primary" onclick="window.location.href='create-course.html'">
                        <i class="fas fa-plus"></i>
                        درس جديد
                    </button>
                    
                    <div class="notifications">
                        <button class="notification-btn" id="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">الكل</button>
                    <button class="filter-tab" data-filter="published">منشور</button>
                    <button class="filter-tab" data-filter="draft">مسودة</button>
                    <button class="filter-tab" data-filter="archived">مؤرشف</button>
                </div>
                
                <div class="filter-actions">
                    <select id="sort-courses" class="filter-select">
                        <option value="newest">الأحدث</option>
                        <option value="oldest">الأقدم</option>
                        <option value="popular">الأكثر مشاهدة</option>
                        <option value="rated">الأعلى تقييماً</option>
                    </select>
                    
                    <button class="filter-btn" id="export-btn">
                        <i class="fas fa-download"></i>
                        تصدير
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الدروس</h3>
                        <p id="total-courses">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي المشاهدات</h3>
                        <p id="total-views">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الطلاب</h3>
                        <p id="total-students">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-info">
                        <h3>متوسط التقييم</h3>
                        <p id="avg-rating">0.0</p>
                    </div>
                </div>
            </div>

            <!-- Courses Grid -->
            <div class="courses-container">
                <div class="courses-header">
                    <h2>جميع الدروس</h2>
                    <span id="courses-count-display">0 درس</span>
                </div>
                
                <div id="courses-grid" class="courses-grid">
                    <!-- سيتم إضافة الدروس هنا بواسطة JavaScript -->
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري تحميل الدروس...</p>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <!-- سيتم إضافة أزرار التصفح هنا -->
            </div>
        </main>
    </div>

    <!-- Quick Actions Menu -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="window.location.href='create-course.html'">
            <i class="fas fa-plus"></i>
        </button>
        <button class="quick-action-btn" onclick="window.location.href='classroom.html'">
            <i class="fas fa-chalkboard-teacher"></i>
        </button>
        <button class="quick-action-btn" onclick="window.location.href='whiteboard.html'">
            <i class="fas fa-paint-brush"></i>
        </button>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/supabase-client.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/course-manager.js"></script>
    <script>
        /**
         * تهيئة صفحة دروسي
         */
        document.addEventListener('DOMContentLoaded', async () => {
            // التحقق من المصادقة
            const isAuth = await auth.requireAuth();
            if (!isAuth) return;
            
            // تحميل بيانات المستخدم
            loadUserData();
            
            // تحميل الدورات
            await loadCourses();
            
            // إعداد المستمعين
            setupEventListeners();
        });

        /**
         * تحميل بيانات المستخدم
         */
        async function loadUserData() {
            const user = auth.getCurrentUser();
            
            if (user) {
                document.getElementById('user-name').textContent = 
                    user.user_metadata?.full_name || user.email;
                document.getElementById('user-email').textContent = user.email;
                
                const initials = auth.getInitials(user.user_metadata?.full_name || user.email);
                document.getElementById('user-avatar').textContent = initials;
            }
        }

        /**
         * تحميل الدورات
         */
        async function loadCourses(filter = 'all', sort = 'newest') {
            try {
                const user = auth.getCurrentUser();
                if (!user) return;
                
                const { data: courses, error } = await supabase.client
                    .from('courses')
                    .select('*')
                    .eq('user_id', user.id)
                    .order(getSortField(sort), { ascending: sort === 'oldest' });
                
                if (error) throw error;
                
                // تصفية حسب الحالة
                let filteredCourses = courses;
                if (filter !== 'all') {
                    filteredCourses = courses.filter(c => c.status === filter);
                }
                
                // تحديث الواجهة
                displayCourses(filteredCourses);
                updateStats(courses);
                
            } catch (error) {
                console.error('Load courses error:', error);
                showError('فشل تحميل الدروس');
            }
        }

        /**
         * عرض الدورات
         */
        function displayCourses(courses) {
            const grid = document.getElementById('courses-grid');
            const countDisplay = document.getElementById('courses-count-display');
            
            if (!courses || courses.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-video"></i>
                        <h3>لا توجد دروس</h3>
                        <p>ابدأ بإنشاء أول درس تفاعلي لك</p>
                        <a href="create-course.html" class="btn-primary">
                            <i class="fas fa-plus"></i>
                            إنشاء درس جديد
                        </a>
                    </div>
                `;
                countDisplay.textContent = '0 درس';
                return;
            }
            
            let html = '';
            
            courses.forEach(course => {
                const statusClass = getStatusClass(course.status);
                const statusText = getStatusText(course.status);
                
                html += `
                    <div class="course-card" data-id="${course.id}">
                        <div class="course-thumbnail">
                            <img src="${course.thumbnail_url || '../assets/images/default-thumbnail.jpg'}" 
                                 alt="${course.title}"
                                 onerror="this.src='../assets/images/default-thumbnail.jpg'">
                            <span class="course-duration">${Utils.formatTime(course.duration || 0)}</span>
                            <span class="course-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="course-info">
                            <h3 class="course-title">${course.title}</h3>
                            <p class="course-description">${Utils.truncate(course.description || '', 80)}</p>
                            
                            <div class="course-meta">
                                <span title="الطلاب">
                                    <i class="fas fa-users"></i>
                                    ${course.total_students || 0}
                                </span>
                                <span title="المشاهدات">
                                    <i class="fas fa-eye"></i>
                                    ${course.total_views || 0}
                                </span>
                                <span title="التفاعلات">
                                    <i class="fas fa-comments"></i>
                                    ${course.total_interactions || 0}
                                </span>
                                <span title="التقييم">
                                    <i class="fas fa-star"></i>
                                    ${(course.average_rating || 0).toFixed(1)}
                                </span>
                            </div>
                            
                            <div class="course-actions">
                                <button class="action-btn" onclick="editCourse('${course.id}')" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn" onclick="viewCourse('${course.id}')" title="مشاهدة">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="shareCourse('${course.id}')" title="مشاركة">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="action-btn" onclick="analyticsCourse('${course.id}')" title="تحليلات">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button class="action-btn" onclick="duplicateCourse('${course.id}')" title="نسخ">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteCourse('${course.id}')" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="course-progress">
                                <span>معدل الإكمال</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${course.completion_rate || 0}%"></div>
                                </div>
                                <span>${(course.completion_rate || 0).toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            countDisplay.textContent = `${courses.length} درس`;
            document.getElementById('courses-count').textContent = courses.length;
        }

        /**
         * تحديث الإحصائيات
         */
        function updateStats(courses) {
            let totalViews = 0;
            let totalStudents = 0;
            let totalRating = 0;
            let ratedCourses = 0;
            
            courses.forEach(course => {
                totalViews += course.total_views || 0;
                totalStudents += course.total_students || 0;
                
                if (course.average_rating && course.average_rating > 0) {
                    totalRating += course.average_rating;
                    ratedCourses++;
                }
            });
            
            const avgRating = ratedCourses > 0 ? (totalRating / ratedCourses).toFixed(1) : '0.0';
            
            document.getElementById('total-courses').textContent = courses.length;
            document.getElementById('total-views').textContent = totalViews.toLocaleString();
            document.getElementById('total-students').textContent = totalStudents.toLocaleString();
            document.getElementById('avg-rating').textContent = avgRating;
        }

        /**
         * إعداد مستمعي الأحداث
         */
        function setupEventListeners() {
            // فلاتر
            document.querySelectorAll('.filter-tab').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    const filter = e.target.dataset.filter;
                    const sort = document.getElementById('sort-courses').value;
                    await loadCourses(filter, sort);
                });
            });
            
            // ترتيب
            document.getElementById('sort-courses').addEventListener('change', async (e) => {
                const activeFilter = document.querySelector('.filter-tab.active').dataset.filter;
                await loadCourses(activeFilter, e.target.value);
            });
            
            // بحث
            const searchInput = document.getElementById('search-courses');
            const debouncedSearch = Utils.debounce(async (query) => {
                // تنفيذ البحث
                console.log('Searching:', query);
            }, 500);
            
            searchInput.addEventListener('input', (e) => debouncedSearch(e.target.value));
            
            // قائمة جانبية
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const closeSidebar = document.getElementById('close-sidebar');
            
            menuToggle.addEventListener('click', () => sidebar.classList.add('active'));
            closeSidebar.addEventListener('click', () => sidebar.classList.remove('active'));
            
            // تصدير
            document.getElementById('export-btn').addEventListener('click', exportCourses);
        }

        /**
         * الحصول على حقل الترتيب
         */
        function getSortField(sort) {
            const fields = {
                'newest': 'created_at',
                'oldest': 'created_at',
                'popular': 'total_views',
                'rated': 'average_rating'
            };
            return fields[sort] || 'created_at';
        }

        /**
         * الحصول على كلاس الحالة
         */
        function getStatusClass(status) {
            const classes = {
                'published': 'status-published',
                'draft': 'status-draft',
                'archived': 'status-archived'
            };
            return classes[status] || 'status-draft';
        }

        /**
         * الحصول على نص الحالة
         */
        function getStatusText(status) {
            const texts = {
                'published': 'منشور',
                'draft': 'مسودة',
                'archived': 'مؤرشف'
            };
            return texts[status] || 'مسودة';
        }

        /**
         * تعديل دورة
         */
        function editCourse(courseId) {
            window.location.href = `create-course.html?edit=${courseId}`;
        }

        /**
         * مشاهدة دورة
         */
        function viewCourse(courseId) {
            window.location.href = `viewer.html?course=${courseId}`;
        }

        /**
         * مشاركة دورة
         */
        async function shareCourse(courseId) {
            const url = `${window.location.origin}/pages/viewer.html?course=${courseId}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'درس تفاعلي من تعليمي',
                        text: 'انضم إلي في هذا الدرس التفاعلي',
                        url: url
                    });
                } catch (error) {
                    console.error('Share error:', error);
                }
            } else {
                await Utils.copyToClipboard(url);
                auth.showNotification('✅ تم نسخ رابط الدرس', 'success');
            }
        }

        /**
         * تحليلات الدورة
         */
        function analyticsCourse(courseId) {
            window.location.href = `analytics.html?course=${courseId}`;
        }

        /**
         * نسخ دورة
         */
        async function duplicateCourse(courseId) {
            try {
                const course = await courseManager.getCourse(courseId);
                if (!course.success) throw new Error('Course not found');
                
                const duplicateData = {
                    ...course.data,
                    title: `${course.data.title} (نسخة)`,
                    status: 'draft',
                    slug: Utils.slugify(`${course.data.title} نسخة ${Date.now()}`)
                };
                
                delete duplicateData.id;
                delete duplicateData.created_at;
                delete duplicateData.updated_at;
                delete duplicateData.published_at;
                
                const result = await courseManager.createCourse(duplicateData);
                
                if (result.success) {
                    auth.showNotification('✅ تم نسخ الدورة بنجاح', 'success');
                    await loadCourses();
                }
                
            } catch (error) {
                console.error('Duplicate course error:', error);
                auth.showNotification('❌ فشل نسخ الدورة', 'error');
            }
        }

        /**
         * حذف دورة
         */
        async function deleteCourse(courseId) {
            if (!confirm('هل أنت متأكد من حذف هذه الدورة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            const result = await courseManager.deleteCourse(courseId);
            
            if (result.success) {
                await loadCourses();
            }
        }

        /**
         * تصدير الدورات
         */
        async function exportCourses() {
            try {
                const user = auth.getCurrentUser();
                if (!user) return;
                
                const { data: courses, error } = await supabase.client
                    .from('courses')
                    .select('*')
                    .eq('user_id', user.id);
                
                if (error) throw error;
                
                const exportData = {
                    exported_at: new Date().toISOString(),
                    user_id: user.id,
                    user_email: user.email,
                    courses: courses
                };
                
                Utils.downloadFile(
                    JSON.stringify(exportData, null, 2),
                    `ta3lemi-courses-${Date.now()}.json`,
                    'application/json'
                );
                
                auth.showNotification('✅ تم تصدير الدورات بنجاح', 'success');
                
            } catch (error) {
                console.error('Export courses error:', error);
                auth.showNotification('❌ فشل تصدير الدورات', 'error');
            }
        }

        /**
         * إظهار خطأ
         */
        function showError(message) {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>عذراً، حدث خطأ</h3>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i>
                        إعادة تحميل
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>