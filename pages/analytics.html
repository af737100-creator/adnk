<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
    <meta name="description" content="ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="../assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="../manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="dashboard-page">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <h2>ØªØ¹Ù„ÙŠÙ…ÙŠ</h2>
                </div>
                <button class="close-sidebar" id="close-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-user">
                <div class="user-avatar" id="user-avatar">Ù…</div>
                <div class="user-info">
                    <h4 id="user-name">Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</h4>
                    <p id="user-email">teacher@example.com</p>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                        </a>
                    </li>
                    <li>
                        <a href="create-course.html">
                            <i class="fas fa-plus-circle"></i>
                            <span>Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</span>
                        </a>
                    </li>
                    <li>
                        <a href="my-courses.html">
                            <i class="fas fa-video"></i>
                            <span>Ø¯Ø±ÙˆØ³ÙŠ</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="analytics.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                        </a>
                    </li>
                    <li>
                        <a href="classroom.html">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                        </a>
                    </li>
                    <li>
                        <a href="whiteboard.html">
                            <i class="fas fa-paint-brush"></i>
                            <span>Ø§Ù„Ø³Ø¨ÙˆØ±Ø©</span>
                        </a>
                    </li>
                    <li>
                        <a href="students.html">
                            <i class="fas fa-users"></i>
                            <span>Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                        </a>
                    </li>
                    <li>
                        <a href="settings.html">
                            <i class="fas fa-cog"></i>
                            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="profile.html" class="profile-link">
                    <i class="fas fa-user"></i>
                    <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                </a>
                <button onclick="auth.signOut()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
                </div>
                
                <div class="header-right">
                    <div class="date-range">
                        <select id="date-range">
                            <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
                            <option value="30" selected>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
                            <option value="90">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</option>
                            <option value="365">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
                        </select>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-secondary" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn-secondary" onclick="exportReport('csv')">
                            <i class="fas fa-file-csv"></i>
                            CSV
                        </button>
                        <button class="btn-secondary" onclick="exportReport('json')">
                            <i class="fas fa-file-code"></i>
                            JSON
                        </button>
                    </div>
                </div>
            </header>

            <!-- Date Filter -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="start-date">
                </div>
                <div class="filter-group">
                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="end-date">
                </div>
                <div class="filter-group">
                    <label>Ø§Ù„Ø¯ÙˆØ±Ø©:</label>
                    <select id="course-filter">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i>
                    ØªØ·Ø¨ÙŠÙ‚
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-info">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <p id="total-students">0</p>
                        <span id="students-trend" class="trend positive">
                            <i class="fas fa-arrow-up"></i> +12%
                        </span>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="card-info">
                        <h3>Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h3>
                        <p id="total-courses">0</p>
                        <span id="courses-trend" class="trend positive">
                            <i class="fas fa-arrow-up"></i> +5
                        </span>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-info">
                        <h3>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</h3>
                        <p id="completion-rate">0%</p>
                        <span id="completion-trend" class="trend positive">
                            <i class="fas fa-arrow-up"></i> +8%
                        </span>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="card-info">
                        <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
                        <p id="avg-rating">0.0</p>
                        <span id="rating-trend" class="trend neutral">
                            <i class="fas fa-minus"></i> 0.0
                        </span>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="chart-actions">
                            <button class="chart-action" onclick="exportChart('progress')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
                
                <!-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª</h3>
                        <div class="chart-actions">
                            <button class="chart-action" onclick="exportChart('interactions')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="interactions-chart"></canvas>
                    </div>
                </div>
                
                <!-- Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="chart-actions">
                            <button class="chart-action" onclick="exportChart('performance')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                        <div class="chart-actions">
                            <button class="chart-action" onclick="exportChart('enrollments')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="enrollments-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Courses -->
            <section class="data-section">
                <div class="section-header">
                    <h2>Ø£ÙØ¶Ù„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø£Ø¯Ø§Ø¡Ù‹</h2>
                    <a href="my-courses.html" class="view-all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                </div>
                
                <div class="courses-table-container">
                    <table class="courses-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¯ÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                                <th>Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª</th>
                                <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="top-courses">
                            <tr>
                                <td colspan="6" class="loading-row">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="data-section">
                <div class="section-header">
                    <h2>Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h2>
                    <button class="btn-secondary" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt"></i>
                        ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                
                <div class="activity-timeline" id="activity-timeline">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/supabase-client.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/analytics.js"></script>
    <script>
        /**
         * ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
         */
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            const isAuth = await auth.requireAuth();
            if (!isAuth) return;
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            loadUserData();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù„Ù„ÙÙ„ØªØ±
            await loadCourses();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©
            await loadAnalyticsData();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            setupEventListeners();
        });

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
         */
        function loadUserData() {
            const user = auth.getCurrentUser();
            
            if (user) {
                document.getElementById('user-name').textContent = 
                    user.user_metadata?.full_name || user.email;
                document.getElementById('user-email').textContent = user.email;
                
                const initials = auth.getInitials(user.user_metadata?.full_name || user.email);
                document.getElementById('user-avatar').textContent = initials;
            }
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù„Ù„ÙÙ„ØªØ±
         */
        async function loadCourses() {
            try {
                const user = auth.getCurrentUser();
                if (!user) return;
                
                const { data: courses, error } = await supabase.client
                    .from('courses')
                    .select('id, title')
                    .eq('user_id', user.id)
                    .eq('status', 'published');
                
                if (error) throw error;
                
                const select = document.getElementById('course-filter');
                select.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</option>';
                
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.id}">${course.title}</option>`;
                });
                
            } catch (error) {
                console.error('Load courses error:', error);
            }
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©
         */
        async function loadAnalyticsData() {
            try {
                const user = auth.getCurrentUser();
                if (!user) return;
                
                // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const stats = await analytics.getUserStats(user.id);
                
                if (stats) {
                    document.getElementById('total-students').textContent = stats.totalStudents.toLocaleString();
                    document.getElementById('total-courses').textContent = stats.totalCourses;
                    document.getElementById('completion-rate').textContent = `${stats.averageCompletion || 0}%`;
                    document.getElementById('avg-rating').textContent = stats.averageRating;
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø£ÙØ¶Ù„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
                await loadTopCourses(user.id);
                
                // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
                await loadActivity(user.id);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
                createCharts();
                
            } catch (error) {
                console.error('Load analytics error:', error);
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©');
            }
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø£ÙØ¶Ù„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
         */
        async function loadTopCourses(userId) {
            try {
                const { data: courses, error } = await supabase.client
                    .from('courses')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('status', 'published')
                    .order('total_students', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const tbody = document.getElementById('top-courses');
                
                if (!courses || courses.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-row">
                                <i class="fas fa-video"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                courses.forEach(course => {
                    const statusClass = course.status === 'published' ? 'status-published' : 'status-draft';
                    const statusText = course.status === 'published' ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©';
                    
                    html += `
                        <tr>
                            <td>
                                <div class="course-info">
                                    <img src="${course.thumbnail_url || '../assets/images/default-thumbnail.jpg'}" 
                                         alt="${course.title}"
                                         onerror="this.src='../assets/images/default-thumbnail.jpg'">
                                    <div>
                                        <h4>${course.title}</h4>
                                        <small>${Utils.truncate(course.description || '', 50)}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${course.total_students || 0}</td>
                            <td>
                                <div class="progress-cell">
                                    <span>${(course.completion_rate || 0).toFixed(1)}%</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${course.completion_rate || 0}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td>${course.total_interactions || 0}</td>
                            <td>
                                <div class="rating-cell">
                                    <span>${(course.average_rating || 0).toFixed(1)}</span>
                                    <i class="fas fa-star" style="color: #f59e0b;"></i>
                                </div>
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Load top courses error:', error);
            }
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
         */
        async function loadActivity(userId) {
            try {
                const { data: activities, error } = await supabase.client
                    .from('activity_logs')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const timeline = document.getElementById('activity-timeline');
                
                if (!activities || activities.length === 0) {
                    timeline.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                activities.forEach(activity => {
                    const date = Utils.formatDate(activity.created_at, 'relative');
                    let icon = 'fa-circle';
                    let color = '#4299e1';
                    
                    switch (activity.action) {
                        case 'course_created':
                            icon = 'fa-plus-circle';
                            color = '#48bb78';
                            break;
                        case 'course_published':
                            icon = 'fa-check-circle';
                            color = '#48bb78';
                            break;
                        case 'course_edited':
                            icon = 'fa-edit';
                            color = '#4299e1';
                            break;
                        case 'student_enrolled':
                            icon = 'fa-user-plus';
                            color = '#9f7aea';
                            break;
                        case 'interaction_answered':
                            icon = 'fa-check';
                            color = '#ed8936';
                            break;
                    }
                    
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-icon" style="background-color: ${color}20; color: ${color};">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>${getActivityText(activity)}</h4>
                                <span class="timeline-date">${date}</span>
                            </div>
                        </div>
                    `;
                });
                
                timeline.innerHTML = html;
                
            } catch (error) {
                console.error('Load activity error:', error);
            }
        }

        /**
         * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ù†Ø´Ø§Ø·
         */
        function getActivityText(activity) {
            switch (activity.action) {
                case 'course_created':
                    return `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${activity.new_data?.title || ''}`;
                case 'course_published':
                    return `ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯ÙˆØ±Ø©: ${activity.new_data?.title || ''}`;
                case 'course_edited':
                    return `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©: ${activity.new_data?.title || ''}`;
                case 'student_enrolled':
                    return `Ø§Ù†Ø¶Ù… Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø©: ${activity.new_data?.course_title || ''}`;
                case 'interaction_answered':
                    return `ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ ÙÙŠ: ${activity.new_data?.course_title || ''}`;
                default:
                    return activity.action.replace(/_/g, ' ');
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
         */
        function createCharts() {
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø§Ø¨
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            charts.progress = analytics.createLineChart('progress-chart', {
                labels: ['Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 5', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 6'],
                datasets: [{
                    label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„',
                    data: [65, 70, 75, 80, 85, 90],
                    color: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    fill: true
                }]
            }, {
                showLegend: false
            });
            
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
            const interactionsCtx = document.getElementById('interactions-chart').getContext('2d');
            charts.interactions = analytics.createPieChart('interactions-chart', {
                labels: ['Ø£Ø³Ø¦Ù„Ø©', 'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', 'Ø´Ø±ÙˆØ­Ø§Øª', 'Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª'],
                values: [45, 25, 20, 10],
                colors: ['#4361ee', '#4ade80', '#f59e0b', '#ef4444']
            });
            
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨
            const performanceCtx = document.getElementById('performance-chart').getContext('2d');
            charts.performance = analytics.createBarChart('performance-chart', {
                labels: ['Ù…Ù…ØªØ§Ø²', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ø¬ÙŠØ¯', 'Ù…Ù‚Ø¨ÙˆÙ„', 'Ø¶Ø¹ÙŠÙ'],
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
                    data: [45, 78, 56, 23, 12],
                    color: '#4361ee'
                }]
            });
            
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            const enrollmentsCtx = document.getElementById('enrollments-chart').getContext('2d');
            charts.enrollments = analytics.createLineChart('enrollments-chart', {
                labels: ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'],
                datasets: [{
                    label: 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª',
                    data: [12, 19, 15, 17, 24, 8, 5],
                    color: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true
                }]
            }, {
                showLegend: false
            });
        }

        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
         */
        function applyFilters() {
            auth.showNotification('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            setTimeout(() => {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                loadAnalyticsData();
                auth.showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
            }, 1000);
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
         */
        function exportReport(format) {
            const reportData = {
                generated_at: new Date().toISOString(),
                user: auth.getCurrentUser()?.email,
                period: document.getElementById('date-range').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
                course_filter: document.getElementById('course-filter').value,
                summary: {
                    total_students: document.getElementById('total-students').textContent,
                    total_courses: document.getElementById('total-courses').textContent,
                    completion_rate: document.getElementById('completion-rate').textContent,
                    avg_rating: document.getElementById('avg-rating').textContent
                }
            };
            
            analytics.exportReport(reportData, format);
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ
         */
        function exportChart(chartId) {
            const canvas = document.getElementById(`${chartId}-chart`);
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `chart-${chartId}-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            auth.showNotification('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ', 'success');
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
         */
        function refreshActivity() {
            const user = auth.getCurrentUser();
            if (user) {
                loadActivity(user.id);
                auth.showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª', 'success');
            }
        }

        /**
         * Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
         */
        function setupEventListeners() {
            // Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const closeSidebar = document.getElementById('close-sidebar');
            
            menuToggle.addEventListener('click', () => sidebar.classList.add('active'));
            closeSidebar.addEventListener('click', () => sidebar.classList.remove('active'));
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·Ø£
         */
        function showError(message) {
            auth.showNotification(message, 'error');
        }

        /**
         * ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
         */
        window.addEventListener('beforeunload', () => {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
        });
    </script>
</body>
</html>