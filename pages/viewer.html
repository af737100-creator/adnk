<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุดุงูุฏุฉ ุงูุฏุฑุณ - ุชุนูููู</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="viewer-page">
    <!-- ุดุฑูุท ุงูุชููู ุงูุนููู -->
    <nav class="viewer-navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../index.html">
                    <i class="fas fa-graduation-cap"></i>
                    <span>ุชุนูููู</span>
                </a>
            </div>
            
            <div class="viewer-info">
                <h1 id="course-title">ููุฏูุฉ ูู ุงูุจุฑูุฌุฉ</h1>
                <p id="course-instructor">ูุน ุงูุฃุณุชุงุฐ ูุญูุฏ ุฃุญูุฏ</p>
            </div>
            
            <div class="nav-actions">
                <button class="action-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="action-btn" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn-primary" onclick="completeCourse()">
                    <i class="fas fa-check"></i> ุฅููุงู ุงูุฏุฑุณ
                </button>
            </div>
        </div>
    </nav>

    <div class="viewer-container">
        <!-- ุงูุดุฑูุท ุงูุฌุงูุจู -->
        <aside class="viewer-sidebar" id="viewer-sidebar">
            <div class="sidebar-header">
                <h3>ูุญุชูู ุงูุฏุฑุณ</h3>
                <button class="close-sidebar" onclick="toggleSidebar()">&times;</button>
            </div>
            
            <div class="sidebar-content">
                <!-- ูุนูููุงุช ุงูุฏุฑุณ -->
                <div class="lesson-info">
                    <div class="lesson-stats">
                        <div class="stat">
                            <i class="fas fa-clock"></i>
                            <span id="lesson-duration">45:00</span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-question-circle"></i>
                            <span id="interaction-count">8 ุชูุงุนูุงุช</span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-users"></i>
                            <span id="student-count">245 ุทุงูุจ</span>
                        </div>
                    </div>
                    
                    <div class="progress-tracker">
                        <div class="progress-header">
                            <h4>ุชูุฏูู ูู ุงูุฏุฑุณ</h4>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ูุงุฆูุฉ ุงูุชูุงุนูุงุช -->
                <div class="interactions-list">
                    <h4>ุงูุชูุงุนูุงุช</h4>
                    <div class="list-container" id="sidebar-interactions">
                        <!-- ุณูุชู ููุคูุง ุจูุงุณุทุฉ JavaScript -->
                    </div>
                </div>
                
                <!-- ุงูููุงุฑุฏ ุงูุฅุถุงููุฉ -->
                <div class="resources-section">
                    <h4>ุงูููุงุฑุฏ ุงูุฅุถุงููุฉ</h4>
                    <div class="resources-list">
                        <a href="#" class="resource-item">
                            <i class="fas fa-file-pdf"></i>
                            <span>ููุฎุต ุงูุฏุฑุณ PDF</span>
                        </a>
                        <a href="#" class="resource-item">
                            <i class="fas fa-link"></i>
                            <span>ุฑูุงุจุท ูููุฏุฉ</span>
                        </a>
                        <a href="#" class="resource-item">
                            <i class="fas fa-download"></i>
                            <span>ุชุญููู ุงูุชูุงุฑูู</span>
                        </a>
                    </div>
                </div>
                
                <!-- ููุงูุดุฉ ุงูุฏุฑุณ -->
                <div class="discussion-section">
                    <h4>ููุงูุดุฉ ุงูุฏุฑุณ</h4>
                    <div class="discussion-preview">
                        <div class="message">
                            <div class="message-sender">ุฃุญูุฏ:</div>
                            <div class="message-text">ุดูุฑูุง ุนูู ุงูุดุฑุญ ุงููุงุถุญ</div>
                        </div>
                        <button class="btn-secondary" onclick="openDiscussion()">
                            <i class="fas fa-comments"></i> ุงููุดุงุฑูุฉ ูู ุงูููุงุด
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <main class="viewer-main">
            <!-- ูุดุบู ุงูููุฏูู ุงูุชูุงุนูู -->
            <section class="video-section">
                <div class="video-container" id="video-container">
                    <!-- ุณูุชู ุฅุถุงูุฉ ูุดุบู YouTube ููุง -->
                </div>
                
                <!-- ูุนูููุงุช ุงูุฏุฑุณ ุฃุณูู ุงูููุฏูู -->
                <div class="video-meta">
                    <div class="meta-item">
                        <i class="fas fa-eye"></i>
                        <span>245 ูุดุงูุฏุงุช</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>ููุฐ 5 ุฃูุงู</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-star"></i>
                        <span>4.8 (120 ุชูููู)</span>
                    </div>
                </div>
            </section>
            
            <!-- ูุญุชูู ุฅุถุงูู -->
            <section class="content-section">
                <!-- ุงูุชุจููุจุงุช -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="description">ุงููุตู</button>
                    <button class="tab-btn" data-tab="interactions">ุงูุชูุงุนูุงุช</button>
                    <button class="tab-btn" data-tab="resources">ุงูููุงุฑุฏ</button>
                    <button class="tab-btn" data-tab="discussion">ุงูููุงุด</button>
                </div>
                
                <!-- ูุญุชูู ุงูุชุจููุจุงุช -->
                <div class="tab-content active" id="description-tab">
                    <h3>ุนู ูุฐุง ุงูุฏุฑุณ</h3>
                    <p id="course-description">ูุฐุง ุงูุฏุฑุณ ูุชูุงูู ุฃุณุงุณูุงุช ุงูุจุฑูุฌุฉ ุจุงุณุชุฎุฏุงู ูุบุฉ Python. ุณูู ุชุชุนูู ุงูููุงููู ุงูุฃุณุงุณูุฉ ูุงูุชุฑููุจุงุช ุงููุบููุฉ ุงูุฃูููุฉ.</p>
                    
                    <div class="learning-objectives">
                        <h4>ุงูุฃูุฏุงู ุงูุชุนููููุฉ</h4>
                        <ul>
                            <li>ููู ุฃุณุงุณูุงุช ุงูุจุฑูุฌุฉ</li>
                            <li>ุชุนูู ูุชุงุจุฉ ุฃูู ุจุฑูุงูุฌ ุจูุบุฉ Python</li>
                            <li>ููู ููุงูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</li>
                            <li>ุงููุฏุฑุฉ ุนูู ุญู ุงููุดููุงุช ุงูุจุณูุทุฉ</li>
                        </ul>
                    </div>
                </div>
                
                <div class="tab-content" id="interactions-tab">
                    <h3>ุงูุชูุงุนูุงุช ุงูููุชููุฉ</h3>
                    <div class="interactions-grid" id="interactions-grid">
                        <!-- ุณูุชู ููุคูุง ุจูุงุณุทุฉ JavaScript -->
                    </div>
                </div>
                
                <div class="tab-content" id="resources-tab">
                    <h3>ุงูููุงุฑุฏ ุงูุชุนููููุฉ</h3>
                    <div class="resources-grid">
                        <div class="resource-card">
                            <div class="resource-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h4>ููุฎุต ุงูุฏุฑุณ</h4>
                            <p>ููุฎุต ุดุงูู ูููุงููู ุงูุฏุฑุณ</p>
                            <a href="#" class="btn-secondary">ุชุญููู</a>
                        </div>
                        <div class="resource-card">
                            <div class="resource-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <h4>ุฃูุซูุฉ ุจุฑูุฌูุฉ</h4>
                            <p>ูุฌููุนุฉ ูู ุงูุฃูุซูุฉ ูุงูุชุทุจููุงุช</p>
                            <a href="#" class="btn-secondary">ุนุฑุถ</a>
                        </div>
                        <div class="resource-card">
                            <div class="resource-icon">
                                <i class="fas fa-video"></i>
                            </div>
                            <h4>ููุฏูููุงุช ุฅุถุงููุฉ</h4>
                            <p>ููุฏูููุงุช ูุชุนููุฉ ุจุงููุญุชูู</p>
                            <a href="#" class="btn-secondary">ูุดุงูุฏุฉ</a>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="discussion-tab">
                    <h3>ููุงุด ุงูุฏุฑุณ</h3>
                    <div class="discussion-container">
                        <div class="discussion-input">
                            <textarea placeholder="ุงูุชุจ ุณุคุงูู ุฃู ุชุนูููู ููุง..."></textarea>
                            <button class="btn-primary">
                                <i class="fas fa-paper-plane"></i> ุฅุฑุณุงู
                            </button>
                        </div>
                        
                        <div class="discussion-thread">
                            <div class="discussion-message">
                                <div class="message-header">
                                    <div class="message-sender">
                                        <div class="sender-avatar">ุฃ</div>
                                        <div class="sender-info">
                                            <strong>ุฃุญูุฏ ูุญูุฏ</strong>
                                            <small>ููุฐ 5 ุณุงุนุงุช</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="message-body">
                                    <p>ุดูุฑูุง ุนูู ุงูุดุฑุญ ุงููุงุถุญุ ูู ูููู ุชูุถูุญ ุงููุฑู ุจูู ุงูููุงุฆู ูุงููุตูููุงุชุ</p>
                                </div>
                                <div class="message-actions">
                                    <button class="action-btn"><i class="fas fa-thumbs-up"></i> 5</button>
                                    <button class="action-btn"><i class="fas fa-reply"></i> ุฑุฏ</button>
                                </div>
                            </div>
                            
                            <div class="discussion-message">
                                <div class="message-header">
                                    <div class="message-sender">
                                        <div class="sender-avatar">ู</div>
                                        <div class="sender-info">
                                            <strong>ุงููุนูู</strong>
                                            <small>ููุฐ 3 ุณุงุนุงุช</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="message-body">
                                    <p>ุงูููุงุฆู ูู Python ูุงุจูุฉ ููุชุบููุฑ ููููููุง ุชุฎุฒูู ุฃููุงุน ูุฎุชููุฉ ูู ุงูุจูุงูุงุชุ ุจูููุง ุงููุตูููุงุช ูู NumPy ุซุงุจุชุฉ ุงูุญุฌู ูุชุฎุฒู ุจูุงูุงุช ูู ููุน ูุงุญุฏ.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ุงูุฏุฑุณ ุงูุชุงูู -->
            <section class="next-lesson">
                <h3>ุงูุฏุฑุณ ุงูุชุงูู</h3>
                <div class="next-lesson-card">
                    <div class="lesson-preview">
                        <div class="lesson-thumbnail">
                            <img src="https://img.youtube.com/vi/next-video/0.jpg" alt="ุงูุฏุฑุณ ุงูุชุงูู">
                        </div>
                        <div class="lesson-info">
                            <h4>ุงูุจุฑูุฌุฉ ุงููุงุฆููุฉ ูู Python</h4>
                            <p>ุชุชุนูู ูู ููุงููู ุงููุงุฆูุงุช ูุงูููุงุณุงุช</p>
                            <div class="lesson-meta">
                                <span><i class="fas fa-clock"></i> 60 ุฏูููุฉ</span>
                                <span><i class="fas fa-question-circle"></i> 10 ุชูุงุนูุงุช</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary" disabled>ูุชุงุญ ุจุนุฏ ุฅููุงู ูุฐุง ุงูุฏุฑุณ</button>
                </div>
            </section>
        </main>
    </div>

    <!-- ูุงูุฐุฉ ุงูุชูุงุนู -->
    <div class="interaction-modal" id="interaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="interaction-title">ุณุคุงู ุชูุงุนูู</h3>
                <button class="close-modal" onclick="closeInteraction()">&times;</button>
            </div>
            
            <div class="modal-body" id="interaction-body">
                <!-- ูุญุชูู ุงูุชูุงุนู -->
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="skipInteraction()">ุชุฎุทู</button>
                <button class="btn-primary" onclick="submitInteraction()">ุฅุฑุณุงู</button>
            </div>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุฅููุงู -->
    <div class="completion-screen" id="completion-screen">
        <div class="completion-content">
            <div class="completion-icon">
                <i class="fas fa-trophy"></i>
            </div>
            
            <h2>๐ ูุจุฑูู! ุฃูููุช ุงูุฏุฑุณ ุจูุฌุงุญ</h2>
            
            <div class="completion-stats">
                <div class="stat">
                    <div class="stat-value" id="completion-time">45:00</div>
                    <div class="stat-label">ุงูููุช ุงููุณุชุบุฑู</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="completion-interactions">8/8</div>
                    <div class="stat-label">ุงูุชูุงุนูุงุช ุงูููุชููุฉ</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="completion-score">92%</div>
                    <div class="stat-label">ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ</div>
                </div>
            </div>
            
            <div class="certificate-section">
                <h4>ุดูุงุฏุฉ ุฅููุงู</h4>
                <p>ููุฏ ุฃูููุช ูุชุทูุจุงุช ุงูุฏุฑุณ ุจูุฌุงุญุ ููููู ุชุญููู ุดูุงุฏุชู ุงูุขู</p>
                <button class="btn-primary" onclick="downloadCertificate()">
                    <i class="fas fa-download"></i> ุชุญููู ุงูุดูุงุฏุฉ
                </button>
            </div>
            
            <div class="completion-actions">
                <button class="btn-secondary" onclick="restartLesson()">
                    <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงููุดุงูุฏุฉ
                </button>
                <button class="btn-primary" onclick="nextLesson()">
                    <i class="fas fa-arrow-left"></i> ุงููุชุงุจุนุฉ ููุฏุฑุณ ุงูุชุงูู
                </button>
                <button class="btn-secondary" onclick="goToDashboard()">
                    <i class="fas fa-home"></i> ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
                </button>
            </div>
        </div>
    </div>

    <!-- ููุชุจุฉ Font Awesome ููุฑููุฒ -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="../scripts/main.js"></script>
    <script src="../scripts/youtube-api.js"></script>
    <script src="../scripts/interactive-player.js"></script>
    <script>
        // ุญุงูุฉ ุงูุชุทุจูู
        let currentCourse = null;
        let interactions = [];
        let completedInteractions = [];
        let player = null;
        let currentInteraction = null;
        let startTime = null;
        let totalWatchedTime = 0;
        let isCompleted = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // ุฌูุจ ุจูุงูุงุช ุงูุฏุฑุณ ูู URL
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('course') || urlParams.get('id') || '1';
            
            loadCourse(courseId);
            setupEventListeners();
            updateProgress();
        });
        
        async function loadCourse(courseId) {
            try {
                // ูู ุงูุชุทุจูู ุงูุญููููุ ุฌูุจ ุงูุจูุงูุงุช ูู Supabase
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                currentCourse = courses.find(c => c.id == courseId) || getSampleCourse();
                
                if (!currentCourse) {
                    showError('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฏุฑุณ');
                    return;
                }
                
                // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
                updateUI();
                
                // ุฅูุดุงุก ูุดุบู YouTube
                createVideoPlayer();
                
                // ุชุญููู ุงูุชูุงุนูุงุช
                interactions = currentCourse.interactions || [];
                loadInteractions();
                
                // ุจุฏุก ุชุชุจุน ุงูููุช
                startTime = new Date();
                startTimeTracker();
                
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฏุฑุณ:', error);
                showError('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฏุฑุณ');
            }
        }
        
        function getSampleCourse() {
            return {
                id: 1,
                title: 'ููุฏูุฉ ูู ุงูุจุฑูุฌุฉ ุจุงุณุชุฎุฏุงู Python',
                description: 'ูุฐุง ุงูุฏุฑุณ ูุชูุงูู ุฃุณุงุณูุงุช ุงูุจุฑูุฌุฉ ุจุงุณุชุฎุฏุงู ูุบุฉ Python. ุณูู ุชุชุนูู ุงูููุงููู ุงูุฃุณุงุณูุฉ ูุงูุชุฑููุจุงุช ุงููุบููุฉ ุงูุฃูููุฉ.',
                youtubeUrl: 'https://www.youtube.com/watch?v=abcdefg',
                youtubeVideoId: 'abcdefg',
                instructor: 'ูุญูุฏ ุฃุญูุฏ',
                duration: 2700, // 45 ุฏูููุฉ ุจุงูุซูุงูู
                interactions: [
                    {
                        id: 1,
                        type: 'question',
                        time: 60,
                        title: 'ุงุฎุชุจุงุฑ ููู ุงูููุงููู',
                        content: 'ูุง ูู ูุบุฉ ุงูุจุฑูุฌุฉ ุงูุชู ูุฏุฑุณูุงุ',
                        options: ['Java', 'Python', 'C++', 'JavaScript'],
                        correctAnswer: 1
                    },
                    {
                        id: 2,
                        type: 'explanation',
                        time: 300,
                        title: 'ูุนูููุฉ ุฅุถุงููุฉ',
                        content: 'Python ูู ูุบุฉ ุจุฑูุฌุฉ ุนุงููุฉ ุงููุณุชููุ ุณููุฉ ุงูุชุนูู ูุชุณุชุฎุฏู ูู ูุฌุงูุงุช ูุชุนุฏุฏุฉ.'
                    },
                    {
                        id: 3,
                        type: 'quiz',
                        time: 900,
                        title: 'ุงุฎุชุจุงุฑ ูุตูุฑ',
                        questions: [
                            {
                                question: 'ูุง ูู ููุฒุฉ Pythonุ',
                                options: ['ุณุฑุนุฉ ุงูุชูููุฐ', 'ุณูููุฉ ุงููุฑุงุกุฉ', 'ุงูุชุนููุฏ', 'ุงูุตุนูุจุฉ'],
                                correctAnswer: 1
                            },
                            {
                                question: 'ููู ูุนุฑู ูุชุบูุฑ ูู Pythonุ',
                                options: ['var x', 'int x', 'x = 5', 'let x'],
                                correctAnswer: 2
                            }
                        ]
                    }
                ],
                stats: {
                    views: 245,
                    rating: 4.8,
                    students: 245,
                    publishedDate: '2023-10-10'
                }
            };
        }
        
        function updateUI() {
            document.getElementById('course-title').textContent = currentCourse.title;
            document.getElementById('course-instructor').textContent = `ูุน ${currentCourse.instructor || 'ุงููุนูู'}`;
            document.getElementById('course-description').textContent = currentCourse.description;
            document.getElementById('lesson-duration').textContent = formatTime(currentCourse.duration);
            document.getElementById('interaction-count').textContent = `${interactions.length} ุชูุงุนูุงุช`;
            document.getElementById('student-count').textContent = `${currentCourse.stats?.students || 0} ุทุงูุจ`;
            
            // ุชุญุฏูุซ ูุนูููุงุช ุงูุฏุฑุณ
            if (currentCourse.stats) {
                document.querySelector('.video-meta').innerHTML = `
                    <div class="meta-item">
                        <i class="fas fa-eye"></i>
                        <span>${currentCourse.stats.views} ูุดุงูุฏุงุช</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>ููุฐ ${formatDate(currentCourse.stats.publishedDate)}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-star"></i>
                        <span>${currentCourse.stats.rating} (${Math.floor(currentCourse.stats.views * 0.5)} ุชูููู)</span>
                    </div>
                `;
            }
        }
        
        function createVideoPlayer() {
            const videoContainer = document.getElementById('video-container');
            videoContainer.innerHTML = '';
            
            if (!currentCourse.youtubeVideoId) {
                videoContainer.innerHTML = '<p class="error">ุฑุงุจุท ุงูููุฏูู ุบูุฑ ูุชุงุญ</p>';
                return;
            }
            
            // ุฅูุดุงุก ูุดุบู YouTube
            const iframe = YouTubeAPI.createYouTubePlayer(currentCourse.youtubeVideoId, {
                width: '100%',
                height: '100%',
                enablejsapi: 1,
                origin: window.location.origin,
                autoplay: 0,
                controls: 1,
                modestbranding: 1
            });
            
            iframe.id = 'youtube-player';
            videoContainer.appendChild(iframe);
            
            // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
            setupPlayerEvents();
        }
        
        function setupPlayerEvents() {
            // ูุฐุง ูุนูู ูุน YouTube IFrame API
            window.onYouTubeIframeAPIReady = function() {
                player = new YT.Player('youtube-player', {
                    events: {
                        'onStateChange': onPlayerStateChange,
                        'onReady': onPlayerReady
                    }
                });
            };
        }
        
        function onPlayerReady(event) {
            console.log('ุงููุดุบู ุฌุงูุฒ');
            
            // ุจุฏุก ุชุชุจุน ุงูุชูุงุนูุงุช
            startInteractionTracker();
        }
        
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                // ุจุฏุก ุชุชุจุน ุงูููุช
                startTimeTracker();
            } else if (event.data === YT.PlayerState.PAUSED) {
                // ุฅููุงู ุชุชุจุน ุงูููุช ูุคูุชูุง
                stopTimeTracker();
            } else if (event.data === YT.PlayerState.ENDED) {
                stopTimeTracker();
                checkCourseCompletion();
            }
        }
        
        function startTimeTracker() {
            if (window.timeTrackerInterval) {
                clearInterval(window.timeTrackerInterval);
            }
            
            window.timeTrackerInterval = setInterval(() => {
                if (player && player.getCurrentTime) {
                    const currentTime = player.getCurrentTime();
                    totalWatchedTime += 1;
                    
                    // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
                    updateProgress();
                    
                    // ุงูุชุญูู ูู ุงูุชูุงุนูุงุช
                    checkInteractions(currentTime);
                }
            }, 1000);
        }
        
        function stopTimeTracker() {
            if (window.timeTrackerInterval) {
                clearInterval(window.timeTrackerInterval);
                window.timeTrackerInterval = null;
            }
        }
        
        function checkInteractions(currentTime) {
            // ุงูุจุญุซ ุนู ุชูุงุนูุงุช ูู ุงูููุช ุงูุญุงูู
            const upcomingInteractions = interactions.filter(interaction => {
                const timeDiff = Math.abs(interaction.time - currentTime);
                return !completedInteractions.includes(interaction.id) && timeDiff <= 2;
            });
            
            if (upcomingInteractions.length > 0 && !currentInteraction) {
                // ุฅููุงู ุงูููุฏูู ูุนุฑุถ ุงูุชูุงุนู
                player.pauseVideo();
                showInteraction(upcomingInteractions[0]);
            }
        }
        
        function showInteraction(interaction) {
            currentInteraction = interaction;
            
            // ุชุญุฏูุซ ุนููุงู ุงููุงูุฐุฉ
            document.getElementById('interaction-title').textContent = interaction.title;
            
            let content = '';
            
            switch (interaction.type) {
                case 'question':
                    content = createQuestionContent(interaction);
                    break;
                    
                case 'quiz':
                    content = createQuizContent(interaction);
                    break;
                    
                case 'explanation':
                    content = createExplanationContent(interaction);
                    break;
                    
                case 'poll':
                    content = createPollContent(interaction);
                    break;
            }
            
            document.getElementById('interaction-body').innerHTML = content;
            document.getElementById('interaction-modal').style.display = 'flex';
        }
        
        function createQuestionContent(interaction) {
            let optionsHtml = '';
            
            if (interaction.options && interaction.options.length > 0) {
                optionsHtml = interaction.options.map((option, index) => `
                    <label class="option-label">
                        <input type="radio" name="answer" value="${index}">
                        <span class="option-text">${option}</span>
                    </label>
                `).join('');
            }
            
            return `
                <div class="question-content">
                    <p>${interaction.content || 'ุฃุฌุจ ุนูู ุงูุณุคุงู ุงูุชุงูู:'}</p>
                    <div class="question-options">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }
        
        function createQuizContent(interaction) {
            let questionsHtml = '';
            
            if (interaction.questions && interaction.questions.length > 0) {
                questionsHtml = interaction.questions.map((question, qIndex) => `
                    <div class="quiz-question">
                        <h4>${qIndex + 1}. ${question.question}</h4>
                        <div class="question-options">
                            ${question.options.map((option, oIndex) => `
                                <label class="option-label">
                                    <input type="radio" name="quiz-${qIndex}" value="${oIndex}">
                                    <span class="option-text">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            return `
                <div class="quiz-content">
                    <p>${interaction.title || 'ุงุฎุชุจุงุฑ ูุตูุฑ'}</p>
                    <div class="quiz-questions">
                        ${questionsHtml}
                    </div>
                </div>
            `;
        }
        
        function createExplanationContent(interaction) {
            return `
                <div class="explanation-content">
                    <div class="explanation-text">
                        ${interaction.content || 'ุดุฑุญ ุฅุถุงูู'}
                    </div>
                    ${interaction.resources ? `
                        <div class="explanation-resources">
                            <h4>ููุงุฑุฏ ุฅุถุงููุฉ:</h4>
                            <ul>
                                ${interaction.resources.map(resource => `
                                    <li><a href="${resource.url}" target="_blank">${resource.title}</a></li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function createPollContent(interaction) {
            let optionsHtml = '';
            
            if (interaction.options && interaction.options.length > 0) {
                optionsHtml = interaction.options.map((option, index) => `
                    <label class="option-label">
                        <input type="radio" name="poll" value="${index}">
                        <span class="option-text">${option}</span>
                    </label>
                `).join('');
            }
            
            return `
                <div class="poll-content">
                    <h4>${interaction.question || 'ุงุณุชุทูุงุน ุฑุฃู'}</h4>
                    <div class="poll-options">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }
        
        function closeInteraction() {
            document.getElementById('interaction-modal').style.display = 'none';
            player.playVideo();
            currentInteraction = null;
        }
        
        function skipInteraction() {
            completedInteractions.push(currentInteraction.id);
            closeInteraction();
            updateProgress();
            saveProgress();
        }
        
        function submitInteraction() {
            if (!currentInteraction) return;
            
            let isCorrect = false;
            
            switch (currentInteraction.type) {
                case 'question':
                    const selectedAnswer = document.querySelector('input[name="answer"]:checked');
                    if (selectedAnswer) {
                        isCorrect = parseInt(selectedAnswer.value) === currentInteraction.correctAnswer;
                    }
                    break;
                    
                case 'quiz':
                    // ุงูุชุญูู ูู ุฌููุน ุฅุฌุงุจุงุช ุงูุงุฎุชุจุงุฑ
                    let correctCount = 0;
                    currentInteraction.questions.forEach((question, qIndex) => {
                        const answer = document.querySelector(`input[name="quiz-${qIndex}"]:checked`);
                        if (answer && parseInt(answer.value) === question.correctAnswer) {
                            correctCount++;
                        }
                    });
                    isCorrect = correctCount === currentInteraction.questions.length;
                    break;
                    
                case 'explanation':
                case 'poll':
                    // ูุฐู ุงูุชูุงุนูุงุช ููุณ ููุง ุฅุฌุงุจุฉ ุตุญูุญุฉ/ุฎุงุทุฆุฉ
                    isCorrect = true;
                    break;
            }
            
            // ุนุฑุถ ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ
            showFeedback(isCorrect);
            
            // ุญูุธ ุงูุชูุงุนู ูููุชูู
            completedInteractions.push(currentInteraction.id);
            
            // ุชุญุฏูุซ ุงูุชูุฏู
            updateProgress();
            saveProgress();
            
            // ุฅุบูุงู ุงููุงูุฐุฉ ุจุนุฏ ุชุฃุฎูุฑ
            setTimeout(() => {
                closeInteraction();
                checkCourseCompletion();
            }, 3000);
        }
        
        function showFeedback(isCorrect) {
            const modalBody = document.getElementById('interaction-body');
            
            let feedbackHtml = '';
            
            if (isCorrect) {
                feedbackHtml = `
                    <div class="feedback correct">
                        <i class="fas fa-check-circle"></i>
                        <h4>ุฅุฌุงุจุฉ ุตุญูุญุฉ! ุฃุญุณูุช</h4>
                        ${currentInteraction.feedback ? `<p>${currentInteraction.feedback}</p>` : ''}
                    </div>
                `;
            } else {
                feedbackHtml = `
                    <div class="feedback incorrect">
                        <i class="fas fa-times-circle"></i>
                        <h4>ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ</h4>
                        <p>ุงูุฑุฌุงุก ูุฑุงุฌุนุฉ ุงููุงุฏุฉ ูุฑุฉ ุฃุฎุฑู</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = feedbackHtml;
            
            // ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
            document.querySelector('.modal-footer').style.display = 'none';
        }
        
        function loadInteractions() {
            // ุชุญุฏูุซ ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
            const sidebarList = document.getElementById('sidebar-interactions');
            const gridList = document.getElementById('interactions-grid');
            
            sidebarList.innerHTML = '';
            gridList.innerHTML = '';
            
            interactions.sort((a, b) => a.time - b.time).forEach((interaction, index) => {
                const isCompleted = completedInteractions.includes(interaction.id);
                
                let icon = 'fa-question-circle';
                let typeText = 'ุณุคุงู';
                
                switch (interaction.type) {
                    case 'quiz': icon = 'fa-clipboard-check'; typeText = 'ุงุฎุชุจุงุฑ'; break;
                    case 'explanation': icon = 'fa-lightbulb'; typeText = 'ุดุฑุญ'; break;
                    case 'poll': icon = 'fa-chart-bar'; typeText = 'ุงุณุชุทูุงุน'; break;
                }
                
                // ูููุงุฆูุฉ ุงูุฌุงูุจูุฉ
                const sidebarItem = document.createElement('div');
                sidebarItem.className = `interaction-sidebar-item ${isCompleted ? 'completed' : ''}`;
                sidebarItem.innerHTML = `
                    <div class="interaction-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="interaction-info">
                        <h5>${interaction.title}</h5>
                        <p>${typeText} - ${formatTime(interaction.time)}</p>
                    </div>
                    ${isCompleted ? '<i class="fas fa-check completed-icon"></i>' : ''}
                `;
                sidebarItem.addEventListener('click', () => seekToInteraction(interaction));
                sidebarList.appendChild(sidebarItem);
                
                // ููุดุจูุฉ ุงูุฑุฆูุณูุฉ
                const gridItem = document.createElement('div');
                gridItem.className = 'interaction-grid-item';
                gridItem.innerHTML = `
                    <div class="interaction-header">
                        <div class="interaction-type">
                            <i class="fas ${icon}"></i>
                            <span>${typeText}</span>
                        </div>
                        <div class="interaction-time">${formatTime(interaction.time)}</div>
                    </div>
                    <h4>${interaction.title}</h4>
                    ${interaction.content ? `<p>${interaction.content.substring(0, 100)}...</p>` : ''}
                    <div class="interaction-status ${isCompleted ? 'completed' : 'pending'}">
                        ${isCompleted ? '<i class="fas fa-check"></i> ููุชูู' : 'ูู ููุชูู ุจุนุฏ'}
                    </div>
                `;
                gridItem.addEventListener('click', () => seekToInteraction(interaction));
                gridList.appendChild(gridItem);
            });
            
            if (interactions.length === 0) {
                sidebarList.innerHTML = '<p class="empty">ูุง ุชูุฌุฏ ุชูุงุนูุงุช ูู ูุฐุง ุงูุฏุฑุณ</p>';
                gridList.innerHTML = '<p class="empty">ูุง ุชูุฌุฏ ุชูุงุนูุงุช ูู ูุฐุง ุงูุฏุฑุณ</p>';
            }
        }
        
        function seekToInteraction(interaction) {
            if (player && player.seekTo) {
                player.seekTo(interaction.time, true);
                
                // ุฅููุงู ุงูุชุดุบูู ูุคูุชูุง ุฅุฐุง ูุงู ูุนูู
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                }
            }
        }
        
        function updateProgress() {
            const totalInteractions = interactions.length;
            const completedCount = completedInteractions.length;
            const progressPercent = totalInteractions > 0 ? (completedCount / totalInteractions) * 100 : 0;
            
            // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
            document.getElementById('progress-percent').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // ุงูุชุญูู ููุง ุฅุฐุง ุชู ุฅููุงู ุงูุฏุฑุณ
            if (progressPercent >= 100 && !isCompleted) {
                completeCourse();
            }
        }
        
        function saveProgress() {
            // ูู ุงูุชุทุจูู ุงูุญููููุ ุญูุธ ูู Supabase
            const progressData = {
                courseId: currentCourse.id,
                userId: getCurrentUserId(),
                completedInteractions: completedInteractions,
                totalWatchedTime: totalWatchedTime,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem(`progress_${currentCourse.id}`, JSON.stringify(progressData));
        }
        
        function loadProgress() {
            const progressData = JSON.parse(localStorage.getItem(`progress_${currentCourse.id}`) || '{}');
            
            if (progressData.completedInteractions) {
                completedInteractions = progressData.completedInteractions;
            }
            
            if (progressData.totalWatchedTime) {
                totalWatchedTime = progressData.totalWatchedTime;
            }
            
            updateProgress();
        }
        
        function checkCourseCompletion() {
            if (completedInteractions.length >= interactions.length && !isCompleted) {
                // ุงูุชุญูู ูู ููุช ุงููุดุงูุฏุฉ (ุนูู ุงูุฃูู 80% ูู ูุฏุฉ ุงูููุฏูู)
                const watchedPercent = (totalWatchedTime / currentCourse.duration) * 100;
                
                if (watchedPercent >= 80) {
                    completeCourse();
                }
            }
        }
        
        function completeCourse() {
            isCompleted = true;
            
            // ุฅููุงู ุชุชุจุน ุงูููุช
            stopTimeTracker();
            
            // ุชุญุฏูุซ ุจูุงูุงุช ุงูุฅููุงู
            const endTime = new Date();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            
            document.getElementById('completion-time').textContent = formatTime(totalTime);
            document.getElementById('completion-interactions').textContent = `${completedInteractions.length}/${interactions.length}`;
            
            // ุญุณุงุจ ุงููุชูุฌุฉ
            const score = interactions.length > 0 ? 
                Math.round((completedInteractions.length / interactions.length) * 100) : 100;
            document.getElementById('completion-score').textContent = `${score}%`;
            
            // ุนุฑุถ ุดุงุดุฉ ุงูุฅููุงู
            document.getElementById('completion-screen').style.display = 'flex';
            
            // ุญูุธ ุญุงูุฉ ุงูุฅููุงู
            saveCompletion();
        }
        
        function saveCompletion() {
            // ูู ุงูุชุทุจูู ุงูุญููููุ ุญูุธ ูู Supabase
            const completionData = {
                courseId: currentCourse.id,
                userId: getCurrentUserId(),
                completedAt: new Date().toISOString(),
                totalTime: totalWatchedTime,
                score: Math.round((completedInteractions.length / interactions.length) * 100),
                interactionsCompleted: completedInteractions.length,
                totalInteractions: interactions.length
            };
            
            localStorage.setItem(`completion_${currentCourse.id}`, JSON.stringify(completionData));
        }
        
        function downloadCertificate() {
            // ูู ุงูุชุทุจูู ุงูุญููููุ ุฅูุดุงุก ูุชุญููู ุดูุงุฏุฉ
            alert('ุณูุชู ุฅูุดุงุก ุดูุงุฏุฉ ุงูุฅููุงู ูุชุญููููุง');
            
            // ูุญุงูุงุฉ ุงูุชุญููู
            const link = document.createElement('a');
            link.href = '#';
            link.download = `ุดูุงุฏุฉ_${currentCourse.title}.pdf`;
            link.click();
        }
        
        function restartLesson() {
            if (confirm('ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ูุดุงูุฏุฉ ุงูุฏุฑุณ ูู ุงูุจุฏุงูุฉุ')) {
                // ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุฏู
                completedInteractions = [];
                totalWatchedTime = 0;
                isCompleted = false;
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูููุฏูู
                if (player && player.seekTo) {
                    player.seekTo(0, true);
                    player.playVideo();
                }
                
                // ุฅุฎูุงุก ุดุงุดุฉ ุงูุฅููุงู
                document.getElementById('completion-screen').style.display = 'none';
                
                // ุชุญุฏูุซ ุงููุงุฌูุฉ
                updateProgress();
                loadInteractions();
                
                // ุฅุนุงุฏุฉ ุจุฏุก ุงูุชุชุจุน
                startTime = new Date();
                startTimeTracker();
            }
        }
        
        function nextLesson() {
            // ูู ุงูุชุทุจูู ุงูุญููููุ ุงูุชูุฌูู ููุฏุฑุณ ุงูุชุงูู
            alert('ุณูุชู ุชูุฌููู ููุฏุฑุณ ุงูุชุงูู');
            window.location.href = 'dashboard.html';
        }
        
        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('viewer-sidebar');
            sidebar.classList.toggle('active');
        }
        
        function toggleFullscreen() {
            const elem = document.documentElement;
            
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        function openDiscussion() {
            // ุงูุชุจุฏูู ุฅูู ุชุจููุจ ุงูููุงุด
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="discussion"]').classList.add('active');
            document.getElementById('discussion-tab').classList.add('active');
        }
        
        function setupEventListeners() {
            // ุฃุญุฏุงุซ ุงูุชุจููุจุงุช
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // ุฅุฒุงูุฉ ุงููุดุงุท ูู ุฌููุน ุงูุชุจููุจุงุช
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // ุฅุถุงูุฉ ุงููุดุงุท ููุชุจููุจ ุงููุญุฏุฏ
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // ุชุญููู ุงูุชูุฏู ุงููุญููุธ
            loadProgress();
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'ููู';
            if (diffDays <= 7) return `${diffDays} ุฃูุงู`;
            if (diffDays <= 30) return `${Math.floor(diffDays / 7)} ุฃุณุงุจูุน`;
            
            return `${Math.floor(diffDays / 30)} ุฃุดูุฑ`;
        }
        
        function getCurrentUserId() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.id || 'anonymous';
        }
        
        function showError(message) {
            const mainContent = document.querySelector('.viewer-main');
            mainContent.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>ุญุฏุซ ุฎุทุฃ</h2>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="window.location.href='dashboard.html'">
                        ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
                    </button>
                </div>
            `;
        }
        
        // ุจุฏุก ุชุชุจุน ุงูุชูุงุนูุงุช
        function startInteractionTracker() {
            setInterval(() => {
                if (player && player.getCurrentTime) {
                    const currentTime = player.getCurrentTime();
                    checkInteractions(currentTime);
                }
            }, 1000);
        }
        
        // ุฏุนู ููุงุชูุญ ุงูุงุฎุชุตุงุฑ
        document.addEventListener('keydown', function(event) {
            if (!player) return;
            
            switch (event.key) {
                case ' ':
                case 'k':
                    event.preventDefault();
                    if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                        player.pauseVideo();
                    } else {
                        player.playVideo();
                    }
                    break;
                    
                case 'f':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                    
                case 'm':
                    event.preventDefault();
                    player.isMuted() ? player.unMute() : player.mute();
                    break;
                    
                case 'ArrowLeft':
                    event.preventDefault();
                    const currentTime = player.getCurrentTime();
                    player.seekTo(currentTime - 5, true);
                    break;
                    
                case 'ArrowRight':
                    event.preventDefault();
                    const currentTime2 = player.getCurrentTime();
                    player.seekTo(currentTime2 + 5, true);
                    break;
            }
        });
    </script>
</body>
</html>