<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تعليمي - منصة التعلم التفاعلي</title>
    <!-- Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* جميع التنسيقات السابقة (نفسها) - احتفظ بها */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f8fafc; color: #1e293b; direction: rtl; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: bold; color: #4361ee; cursor: pointer; background: none; border: none; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a, .nav-links button { text-decoration: none; color: #1e293b; padding: 8px 16px; border-radius: 8px; background: none; border: none; cursor: pointer; font-size: 1rem; }
        .btn-login { border: 2px solid #4361ee; color: #4361ee !important; }
        .btn-signup { background: #4361ee; color: white !important; }
        .hamburger { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .btn { background: #4361ee; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-block; text-decoration: none; }
        .btn-outline { background: white; color: #4361ee; border: 2px solid #4361ee; }
        .btn-sm { padding: 8px 20px; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(67,97,238,0.2); }
        .hero { padding: 80px 0; background: linear-gradient(135deg, #eef2ff, white); text-align: center; }
        .hero h1 { font-size: 2.8rem; margin-bottom: 20px; }
        .hero p { font-size: 1.2rem; color: #64748b; max-width: 700px; margin: 0 auto 30px; }
        .section-title { font-size: 2.2rem; margin: 60px 0 30px; text-align: center; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin: 40px 0; }
        .feature-card { background: white; padding: 30px; border-radius: 20px; border: 1px solid #e2e8f0; text-align: center; }
        .feature-icon { font-size: 2.5rem; color: #4361ee; margin-bottom: 15px; }
        .steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 40px 0; }
        .step { text-align: center; }
        .step-number { width: 60px; height: 60px; background: #4361ee; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; margin: 0 auto 20px; }
        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin: 40px 0; }
        .pricing-card { background: white; padding: 40px 30px; border-radius: 20px; border: 1px solid #e2e8f0; position: relative; text-align: center; }
        .pricing-card.popular { border: 2px solid #4361ee; transform: scale(1.05); }
        .popular-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #4361ee; color: white; padding: 5px 20px; border-radius: 20px; font-size: 0.9rem; }
        .price { font-size: 2.5rem; font-weight: bold; margin: 20px 0; }
        .pricing-features { list-style: none; margin: 30px 0; text-align: right; }
        .pricing-features li { padding: 10px 0; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .pricing-features i.fa-check { color: #4ade80; }
        .pricing-features i.fa-times { color: #ef4444; }
        .dashboard-layout { display: flex; gap: 30px; margin: 30px 0; }
        .sidebar { width: 280px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .sidebar h3 { margin-bottom: 20px; color: #4361ee; }
        .sidebar button { display: block; width: 100%; padding: 15px; margin-bottom: 8px; border: none; background: none; border-radius: 12px; text-align: right; cursor: pointer; font-size: 1rem; color: #334155; }
        .sidebar button:hover, .sidebar button.active { background: #eef2ff; color: #4361ee; font-weight: 600; }
        .main-panel { flex: 1; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: #f8fafc; padding: 20px; border-radius: 16px; text-align: center; }
        .stat-card h2 { font-size: 2.2rem; color: #4361ee; margin-bottom: 5px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #4361ee; outline: none; }
        .video-container { position: relative; width: 100%; background: #000; border-radius: 16px; overflow: hidden; margin: 20px 0; }
        .video-wrapper { position: relative; padding-top: 56.25%; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .interaction-point { position: absolute; width: 40px; height: 40px; background: rgba(67,97,238,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(67,97,238,0.7);} 50%{box-shadow:0 0 0 10px rgba(67,97,238,0);} }
        .interactions-list { margin-top: 30px; background: #f8fafc; border-radius: 16px; padding: 20px; }
        .interaction-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .interaction-icon { width: 40px; height: 40px; background: #eef2ff; color: #4361ee; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        footer { background: #1e293b; color: white; padding: 60px 0 20px; margin-top: 60px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-section h3 { margin-bottom: 20px; color: white; }
        .footer-section ul { list-style: none; }
        .footer-section a { color: #cbd5e1; text-decoration: none; }
        .footer-bottom { text-align: center; padding-top: 20px; border-top: 1px solid #334155; }
        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .steps { grid-template-columns: 1fr; }
            .pricing-grid { grid-template-columns: 1fr; }
            .dashboard-layout { flex-direction: column; }
            .sidebar { width: 100%; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .hamburger { display: block; }
            .nav-links { display: none; flex-direction: column; position: absolute; top: 70px; right: 0; width: 100%; background: white; padding: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.1); z-index: 999; }
            .nav-links.show { display: flex; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================
        // تهيئة Supabase (باستخدام بياناتك)
        // ============================================
        const SUPABASE_URL = 'https://ollwqisezqkawrulahqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_eq_PjuSiAbWvxNAD6QHThw_v_x-jVSI';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: window.localStorage
            }
        });

        // ============================================
        // متغيرات عامة
        // ============================================
        let currentPage = 'home';
        let currentUser = null;
        let tempInteractions = [];

        // ============================================
        // دوال المصادقة
        // ============================================
        async function handleLogin() {
            const email = document.getElementById('loginEmail')?.value;
            const password = document.getElementById('loginPassword')?.value;
            
            if (!email || !password) {
                alert('الرجاء إدخال البريد الإلكتروني وكلمة المرور');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                localStorage.setItem('ta3lemi_user', JSON.stringify(currentUser));
                
                alert('✅ تم تسجيل الدخول بنجاح');
                renderPage('dashboard');
            } catch (error) {
                alert('❌ خطأ في تسجيل الدخول: ' + error.message);
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName')?.value;
            const email = document.getElementById('signupEmail')?.value;
            const password = document.getElementById('signupPassword')?.value;
            const role = document.getElementById('signupRole')?.value;

            if (!name || !email || !password) {
                alert('الرجاء ملء جميع الحقول');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            role: role
                        }
                    }
                });

                if (error) throw error;

                alert('✅ تم إنشاء الحساب بنجاح! يرجى تأكيد بريدك الإلكتروني.');
                renderPage('login');
            } catch (error) {
                alert('❌ خطأ في إنشاء الحساب: ' + error.message);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            localStorage.removeItem('ta3lemi_user');
            renderPage('home');
        }

        async function getCurrentUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                currentUser = { ...user, profile };
            } else {
                currentUser = null;
            }
            return currentUser;
        }

        // ============================================
        // دوال جلب البيانات من Supabase
        // ============================================
        async function getMyCourses() {
            if (!currentUser) return [];
            const { data, error } = await supabase
                .from('courses')
                .select('*')
                .eq('teacher_id', currentUser.id)
                .order('created_at', { ascending: false });
            if (error) {
                console.error(error);
                return [];
            }
            return data;
        }

        async function getCourseWithInteractions(courseId) {
            const { data: course, error: courseError } = await supabase
                .from('courses')
                .select('*')
                .eq('id', courseId)
                .single();
            if (courseError) {
                console.error(courseError);
                return null;
            }

            const { data: interactions, error: intError } = await supabase
                .from('interactions')
                .select('*')
                .eq('course_id', courseId)
                .order('time_seconds', { ascending: true });
            if (intError) {
                console.error(intError);
                return course;
            }

            return { ...course, interactions };
        }

        async function saveCourseToSupabase(courseData, interactions) {
            if (!currentUser) return null;

            // إدراج الدورة
            const { data: course, error: courseError } = await supabase
                .from('courses')
                .insert([{
                    teacher_id: currentUser.id,
                    title: courseData.title,
                    description: courseData.description,
                    youtube_url: courseData.youtubeUrl,
                    youtube_video_id: courseData.youtubeId,
                    thumbnail_url: courseData.thumbnail,
                    is_published: true
                }])
                .select()
                .single();

            if (courseError) {
                console.error(courseError);
                alert('❌ فشل حفظ الدورة: ' + courseError.message);
                return null;
            }

            // إدراج التفاعلات
            for (const inter of interactions) {
                await supabase
                    .from('interactions')
                    .insert([{
                        course_id: course.id,
                        type: inter.type,
                        title: inter.title || null,
                        content: inter.content || null,
                        time_seconds: inter.time
                    }]);
            }

            return course;
        }

        // ============================================
        // دوال عرض الصفحات
        // ============================================
        function renderPage(page, params = {}) {
            currentPage = page;
            const app = document.getElementById('app');
            let html = '';

            if (page === 'home') html = renderHome();
            else if (page === 'login') html = renderLogin();
            else if (page === 'signup') html = renderSignup();
            else if (page === 'dashboard') html = renderDashboard();
            else if (page === 'create-course') html = renderCreateCourse();
            else if (page === 'course') html = renderCourse(params.id);

            app.innerHTML = html;
            window.scrollTo(0, 0);
        }

        function renderHome() {
            return `
                <header>
                    <nav class="navbar">
                        <div class="container">
                            <button class="logo" onclick="renderPage('home')">تعليمي</button>
                            <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('show')">☰</button>
                            <div class="nav-links" id="navLinks">
                                <a href="#" onclick="renderPage('home'); return false;">الرئيسية</a>
                                ${currentUser ? `
                                    <span style="color:#4361ee;">${currentUser.user_metadata?.full_name || ''}</span>
                                    <button class="btn-login" onclick="logout()">تسجيل خروج</button>
                                    <button class="btn-signup" onclick="renderPage('dashboard')">لوحة التحكم</button>
                                ` : `
                                    <button class="btn-login" onclick="renderPage('login')">تسجيل الدخول</button>
                                    <button class="btn-signup" onclick="renderPage('signup')">إنشاء حساب</button>
                                `}
                            </div>
                        </div>
                    </nav>
                </header>
                <section class="hero">
                    <div class="container">
                        <h1>حوّل مقاطع اليوتيوب التعليمية إلى تجربة تعلم تفاعلية</h1>
                        <p>أضف أسئلة، اختبارات، وشروحات تفاعلية على أي فيديو تعليمي بدون إعادة التسجيل.</p>
                        <button class="btn" onclick="renderPage('signup')">ابدأ مجاناً</button>
                    </div>
                </section>
                <div class="container">
                    <h2 class="section-title">مميزات منصتنا الفريدة</h2>
                    <div class="features-grid">
                        <div class="feature-card"><i class="fas fa-question-circle feature-icon"></i><h3>أسئلة تفاعلية</h3><p>أضف أسئلة في أي نقطة مع تصحيح فوري.</p></div>
                        <div class="feature-card"><i class="fas fa-clipboard-check feature-icon"></i><h3>اختبارات قصيرة</h3><p>اختبارات متعددة الخيارات مع تحليلات.</p></div>
                        <div class="feature-card"><i class="fas fa-lightbulb feature-icon"></i><h3>شروحات إضافية</h3><p>موارد وروابط عند نقاط محددة.</p></div>
                        <div class="feature-card"><i class="fas fa-chart-line feature-icon"></i><h3>تحليلات متقدمة</h3><p>تتبع تقدم الطلاب.</p></div>
                        <div class="feature-card"><i class="fas fa-users feature-icon"></i><h3>تعليم تعاوني</h3><p>غرف دراسية وسبورة تفاعلية.</p></div>
                        <div class="feature-card"><i class="fas fa-mobile-alt feature-icon"></i><h3>متوافق مع الأجهزة</h3><p>تصميم متجاوب.</p></div>
                    </div>
                    <h2 class="section-title">كيف تعمل المنصة؟</h2>
                    <div class="steps">
                        <div class="step"><div class="step-number">1</div><h3>أدخل رابط الفيديو</h3><p>انسخ رابط أي فيديو يوتيوب.</p></div>
                        <div class="step"><div class="step-number">2</div><h3>أضف التفاعلات</h3><p>ضع أسئلة وشروحات في النقاط المناسبة.</p></div>
                        <div class="step"><div class="step-number">3</div><h3>شارك الدرس</h3><p>احصل على رابط فريد للمشاركة.</p></div>
                        <div class="step"><div class="step-number">4</div><h3>تابع التقدم</h3><p>راقب أداء طلابك.</p></div>
                    </div>
                </div>
                <footer>
                    <div class="container">
                        <div class="footer-content">
                            <div class="footer-section"><h3>تعليمي</h3><p>منصة التعلم التفاعلي الأولى.</p></div>
                            <div class="footer-section"><h3>روابط سريعة</h3><ul><li><a href="#" onclick="renderPage('home'); return false;">الرئيسية</a></li></ul></div>
                            <div class="footer-section"><h3>تواصل معنا</h3><ul><li>support@ta3lemi.com</li></ul></div>
                        </div>
                        <div class="footer-bottom"><p>© 2026 تعليمي</p></div>
                    </div>
                </footer>
            `;
        }

        function renderLogin() {
            return `
                <div style="min-height:80vh; display:flex; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:white; padding:40px; border-radius:20px; max-width:400px; width:100%;">
                        <h2 style="margin-bottom:30px; text-align:center;">تسجيل الدخول</h2>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="loginEmail" placeholder="teacher@example.com">
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="loginPassword" placeholder="******">
                        </div>
                        <button class="btn" style="width:100%;" onclick="handleLogin()">دخول</button>
                        <p style="margin-top:20px; text-align:center;">
                            ليس لديك حساب؟ <a href="#" onclick="renderPage('signup'); return false;">إنشاء حساب</a>
                        </p>
                    </div>
                </div>
            `;
        }

        function renderSignup() {
            return `
                <div style="min-height:80vh; display:flex; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:white; padding:40px; border-radius:20px; max-width:400px; width:100%;">
                        <h2 style="margin-bottom:30px; text-align:center;">إنشاء حساب جديد</h2>
                        <div class="form-group">
                            <label>الاسم الكامل</label>
                            <input type="text" id="signupName">
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="signupEmail">
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="signupPassword">
                        </div>
                        <div class="form-group">
                            <label>نوع الحساب</label>
                            <select id="signupRole">
                                <option value="teacher">معلم</option>
                                <option value="student">طالب</option>
                            </select>
                        </div>
                        <button class="btn" style="width:100%;" onclick="handleSignup()">تسجيل</button>
                        <p style="margin-top:20px; text-align:center;">
                            لديك حساب بالفعل؟ <a href="#" onclick="renderPage('login'); return false;">تسجيل الدخول</a>
                        </p>
                    </div>
                </div>
            `;
        }

        async function renderDashboard() {
            if (!currentUser) {
                renderPage('login');
                return '';
            }

            const courses = await getMyCourses();

            return `
                <header>
                    <nav class="navbar">
                        <div class="container">
                            <button class="logo" onclick="renderPage('home')">تعليمي</button>
                            <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('show')">☰</button>
                            <div class="nav-links">
                                <span style="color:#4361ee;">${currentUser.user_metadata?.full_name || ''}</span>
                                <button class="btn-login" onclick="logout()">تسجيل خروج</button>
                            </div>
                        </div>
                    </nav>
                </header>
                <div class="dashboard-layout container">
                    <aside class="sidebar">
                        <h3>تعليمي</h3>
                        <button class="active" onclick="renderPage('dashboard')">لوحة التحكم</button>
                        <button onclick="renderPage('create-course')">إنشاء درس جديد</button>
                    </aside>
                    <main class="main-panel">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h1>لوحة التحكم</h1>
                            <button class="btn btn-sm" onclick="renderPage('create-course')">+ درس جديد</button>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card"><h2>${courses.length}</h2><p>إجمالي الدروس</p></div>
                            <div class="stat-card"><h2>0</h2><p>الطلاب</p></div>
                            <div class="stat-card"><h2>0%</h2><p>معدل الإكمال</p></div>
                            <div class="stat-card"><h2>0%</h2><p>معدل التفاعل</p></div>
                        </div>
                        <h2>الدروس الخاصة بك</h2>
                        <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                            <thead>
                                <tr><th>العنوان</th><th>التفاعلات</th><th>الحالة</th><th></th></tr>
                            </thead>
                            <tbody>
                                ${courses.length === 0 ? '<tr><td colspan="4">لا توجد دروس بعد. <a href="#" onclick="renderPage(\'create-course\'); return false;">أنشئ أول درس</a></td></tr>' : ''}
                                ${courses.map(c => `
                                    <tr>
                                        <td>${c.title}</td>
                                        <td>0</td>
                                        <td>${c.is_published ? 'منشور' : 'مسودة'}</td>
                                        <td>
                                            <button class="btn-sm" onclick="renderPage('course', {id: '${c.id}'})">عرض</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </main>
                </div>
            `;
        }

        function renderCreateCourse() {
            if (!currentUser) {
                renderPage('login');
                return '';
            }

            return `
                <header>
                    <nav class="navbar">
                        <div class="container">
                            <button class="logo" onclick="renderPage('home')">تعليمي</button>
                            <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('show')">☰</button>
                            <div class="nav-links">
                                <span style="color:#4361ee;">${currentUser.user_metadata?.full_name || ''}</span>
                                <button class="btn-login" onclick="logout()">تسجيل خروج</button>
                            </div>
                        </div>
                    </nav>
                </header>
                <div class="dashboard-layout container">
                    <aside class="sidebar">
                        <h3>تعليمي</h3>
                        <button onclick="renderPage('dashboard')">لوحة التحكم</button>
                        <button class="active" onclick="renderPage('create-course')">إنشاء درس جديد</button>
                    </aside>
                    <main class="main-panel">
                        <button class="btn-outline btn-sm" onclick="renderPage('dashboard')">← رجوع</button>
                        <h1>إنشاء درس جديد</h1>
                        <div class="form-group">
                            <label>عنوان الدرس</label>
                            <input type="text" id="courseTitle" placeholder="مثال: مقدمة في البرمجة">
                        </div>
                        <div class="form-group">
                            <label>وصف الدرس</label>
                            <textarea id="courseDesc" rows="3" placeholder="صف محتوى الدرس..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>رابط فيديو يوتيوب</label>
                            <div style="display:flex; gap:10px;">
                                <input type="url" id="youtubeUrl" placeholder="https://youtube.com/watch?v=..." style="flex:1;">
                                <button class="btn btn-sm" onclick="previewVideo()">معاينة</button>
                            </div>
                        </div>
                        <div id="videoPreview" style="display:none; margin:20px 0; padding:20px; background:#f8fafc; border-radius:12px; text-align:center;">
                            <img id="thumbnail" src="" alt="صورة الفيديو" style="max-width:100%; border-radius:8px;">
                        </div>

                        <h2 style="margin-top:40px;">التفاعلات</h2>
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <button class="btn-outline btn-sm" onclick="showInteractionModal('question')">+ إضافة سؤال</button>
                            <button class="btn-outline btn-sm" onclick="showInteractionModal('quiz')">+ إضافة اختبار</button>
                            <button class="btn-outline btn-sm" onclick="showInteractionModal('explanation')">+ إضافة شرح</button>
                        </div>

                        <div id="interactionsList" class="interactions-list">
                            ${tempInteractions.length === 0 ? '<p>لا توجد تفاعلات بعد. أضف أول تفاعل!</p>' : ''}
                        </div>

                        <button class="btn" style="width:100%; margin-top:30px;" onclick="saveCourse()">حفظ الدرس</button>
                    </main>
                </div>

                <!-- نافذة إضافة تفاعل -->
                <div class="modal" id="interactionModal">
                    <div class="modal-content">
                        <h3 id="modalTitle">إضافة سؤال</h3>
                        <div class="form-group">
                            <label>الوقت (بالثواني)</label>
                            <input type="number" id="interactionTime" min="0" value="0">
                        </div>
                        <div id="modalFields"></div>
                        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                            <button class="btn-outline btn-sm" onclick="closeModal()">إلغاء</button>
                            <button class="btn btn-sm" onclick="saveInteraction()">حفظ</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderCourse(courseId) {
            const course = await getCourseWithInteractions(courseId);
            if (!course) {
                alert('الدورة غير موجودة');
                renderPage('home');
                return '';
            }

            return `
                <header>
                    <nav class="navbar">
                        <div class="container">
                            <button class="logo" onclick="renderPage('home')">تعليمي</button>
                            <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('show')">☰</button>
                            <div class="nav-links">
                                ${currentUser ? `<span style="color:#4361ee;">${currentUser.user_metadata?.full_name || ''}</span>` : ''}
                                ${currentUser ? `<button class="btn-login" onclick="logout()">تسجيل خروج</button>` : `<button class="btn-login" onclick="renderPage('login')">تسجيل الدخول</button>`}
                            </div>
                        </div>
                    </nav>
                </header>
                <div class="container" style="margin-top:30px;">
                    <button class="btn-outline btn-sm" onclick="renderPage('dashboard')">← رجوع</button>
                    <h1 style="margin:20px 0;">${course.title}</h1>
                    <p style="color:#475569; margin-bottom:20px;">${course.description}</p>

                    <div class="video-container">
                        <div class="video-wrapper">
                            <iframe id="player" src="https://www.youtube.com/embed/${course.youtube_video_id}?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
                        </div>
                        <div id="interactionOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                            ${course.interactions ? course.interactions.map(inter => `
                                <div class="interaction-point" style="top:50%; right:${(inter.time_seconds / 600) * 100}%;" onclick="alert('تفاعل: ' + '${inter.type}')">
                                    <i class="fas ${inter.type === 'question' ? 'fa-question' : inter.type === 'quiz' ? 'fa-clipboard-list' : 'fa-info'}"></i>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <h2>تفاعلات الدرس</h2>
                        <div class="interactions-list">
                            ${!course.interactions || course.interactions.length === 0 ? '<p>لا توجد تفاعلات في هذا الدرس.</p>' : ''}
                            ${course.interactions ? course.interactions.map(inter => {
                                const time = formatTime(inter.time_seconds);
                                return `
                                    <div class="interaction-item" onclick="alert('تفاصيل التفاعل: ' + JSON.stringify(inter))">
                                        <div class="interaction-icon"><i class="fas ${inter.type === 'question' ? 'fa-question' : inter.type === 'quiz' ? 'fa-clipboard-list' : 'fa-info'}"></i></div>
                                        <div>
                                            <strong>${inter.type === 'question' ? 'سؤال' : inter.type === 'quiz' ? 'اختبار' : 'شرح'}</strong>
                                            <p>الوقت: ${time}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('') : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // دوال مساعدة
        // ============================================
        function extractYouTubeId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=)([^&]+)/,
                /(?:youtu\.be\/)([^?]+)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function previewVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractYouTubeId(url);
            if (!videoId) {
                alert('❌ رابط يوتيوب غير صالح');
                return;
            }
            document.getElementById('thumbnail').src = `https://img.youtube.com/vi/${videoId}/0.jpg`;
            document.getElementById('videoPreview').style.display = 'block';
        }

        let currentModalType = 'question';
        function showInteractionModal(type) {
            currentModalType = type;
            const modal = document.getElementById('interactionModal');
            const title = document.getElementById('modalTitle');
            const fields = document.getElementById('modalFields');

            if (type === 'question') {
                title.textContent = 'إضافة سؤال';
                fields.innerHTML = `
                    <div class="form-group"><label>نص السؤال</label><textarea id="qText" rows="2" placeholder="أدخل السؤال..."></textarea></div>
                    <div class="form-group"><label>الخيارات (افصل بفاصلة)</label><input type="text" id="qOptions" placeholder="خيار1, خيار2, خيار3"></div>
                    <div class="form-group"><label>رقم الإجابة الصحيحة (0-...)</label><input type="number" id="qCorrect" min="0" value="0"></div>
                `;
            } else if (type === 'quiz') {
                title.textContent = 'إضافة اختبار قصير';
                fields.innerHTML = `
                    <div class="form-group"><label>عنوان الاختبار</label><input type="text" id="quizTitle" placeholder="مثال: اختبار الفصل الأول"></div>
                    <div class="form-group"><label>عدد الأسئلة</label><input type="number" id="quizCount" min="1" value="3"></div>
                `;
            } else if (type === 'explanation') {
                title.textContent = 'إضافة شرح إضافي';
                fields.innerHTML = `
                    <div class="form-group"><label>نص الشرح</label><textarea id="expText" rows="3" placeholder="أدخل الشرح..."></textarea></div>
                    <div class="form-group"><label>رابط إضافي (اختياري)</label><input type="url" id="expUrl" placeholder="https://example.com"></div>
                `;
            }
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('interactionModal').classList.remove('active');
        }

        function saveInteraction() {
            const time = parseInt(document.getElementById('interactionTime').value) || 0;
            let interaction = { id: Date.now().toString(), time };

            if (currentModalType === 'question') {
                const text = document.getElementById('qText').value;
                const options = document.getElementById('qOptions').value.split(',').map(s => s.trim());
                const correct = parseInt(document.getElementById('qCorrect').value);
                if (!text || options.length < 2) {
                    alert('❌ يرجى ملء جميع الحقول');
                    return;
                }
                interaction.type = 'question';
                interaction.content = { text, options, correct };
            } else if (currentModalType === 'quiz') {
                const title = document.getElementById('quizTitle').value;
                const count = parseInt(document.getElementById('quizCount').value);
                if (!title) {
                    alert('❌ يرجى إدخال عنوان الاختبار');
                    return;
                }
                interaction.type = 'quiz';
                interaction.title = title;
                interaction.questionCount = count;
            } else if (currentModalType === 'explanation') {
                const text = document.getElementById('expText').value;
                const url = document.getElementById('expUrl').value;
                if (!text) {
                    alert('❌ يرجى إدخال نص الشرح');
                    return;
                }
                interaction.type = 'explanation';
                interaction.content = { text, url };
            }

            tempInteractions.push(interaction);
            updateInteractionsList();
            closeModal();
        }

        function updateInteractionsList() {
            const list = document.getElementById('interactionsList');
            if (!list) return;
            if (tempInteractions.length === 0) {
                list.innerHTML = '<p>لا توجد تفاعلات بعد. أضف أول تفاعل!</p>';
                return;
            }
            list.innerHTML = tempInteractions.map(i => {
                const time = formatTime(i.time);
                let icon = 'fa-question-circle';
                let color = '#4361ee';
                if (i.type === 'quiz') { icon = 'fa-clipboard-check'; color = '#4ade80'; }
                else if (i.type === 'explanation') { icon = 'fa-lightbulb'; color = '#f59e0b'; }
                return `
                    <div class="interaction-item">
                        <div class="interaction-icon"><i class="fas ${icon}" style="color:${color};"></i></div>
                        <div>
                            <strong>${i.type === 'question' ? 'سؤال' : i.type === 'quiz' ? 'اختبار' : 'شرح'}</strong>
                            <p>الوقت: ${time}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveCourse() {
            const title = document.getElementById('courseTitle').value;
            const description = document.getElementById('courseDesc').value;
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractYouTubeId(url);

            if (!title || !url || !videoId) {
                alert('❌ يرجى ملء جميع الحقول');
                return;
            }

            const courseData = {
                title,
                description,
                youtubeUrl: url,
                youtubeId: videoId,
                thumbnail: `https://img.youtube.com/vi/${videoId}/0.jpg`
            };

            const savedCourse = await saveCourseToSupabase(courseData, tempInteractions);
            if (savedCourse) {
                tempInteractions = [];
                alert('✅ تم حفظ الدرس بنجاح');
                renderPage('dashboard');
            }
        }

        // ============================================
        // بدء التطبيق
        // ============================================
        (async function init() {
            await getCurrentUser();
            renderPage('home');
        })();
    </script>
</body>
</html>